---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval=FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)
```

```{r, include=FALSE, eval=TRUE}
# If you actually want to eval all the code here to check that it runs,
# change actually_eval to TRUE and make sure you run this on a Monday
actually_eval <- FALSE
if (actually_eval & focustools::is_monday()) {
  knitr::opts_chunk$set(eval=TRUE)
}
```


# focustools

<!-- badges: start -->
<!-- badges: end -->

## Installation

Install from GitHub as follows:

``` r
# install.packages("devtools")
devtools::install_github("signaturescience/focustools")
```
## Usage

### Generating forecasts and formatting submission

Here we provide an example of how to use `focustools` to generate forecasts for COVID-19 Forecast Hub targets via time series approaches.

First, load ancillary packages for data analysis and retrieve COVID-19 data from the JHU source. Note that the `get_cases()` and `get_deaths()` functions are executed separately, then joined and converted to a `tsibble`:

```{r}
library(focustools)
library(dplyr)
library(readr)
library(purrr)
library(fabletools)
library(fable)

## get data at the national scale from jhu source
usac <-  get_cases(source="jhu",  granularity = "national")
usad <- get_deaths(source="jhu",  granularity = "national")

## use the focustools helper to prep the tsibble format
usa <-  
  dplyr::inner_join(usac, usad, by = c("epiyear", "epiweek")) %>% 
  make_tsibble(chop=TRUE)

```

With the data prepped, we can now fit the models. In this case, we'll fit two models. One will be an ARIMA of incident cases, with parameters automatically optimized. For more details see `?fable::ARIMA`. The other model will use the three week lagged incident case counts to predict incident deaths:

```{r}
fit.icases <- usa %>% model(arima = ARIMA(icases, stepwise=FALSE, approximation=FALSE))
fit.ideaths <- usa %>% model(linear_caselag3 = TSLM(ideaths ~ lag(icases, 3)))
```

Note that the code above uses the `fabletools::model()` function directly. The `focustools` package does include `ts_fit()`, which is a wrapper for modeling multiple outcomes and/or using a list of model specifications. However, currently `ts_fit()` is incompatible with the `TSLM` model used above for the incident deaths. For an example of `ts_fit()` in action see the "Evaluating model accuracy" section below.

With the model fit objects created, we can generate forecasts (including point and quantile estimates) for the outcomes of interest at an arbitrary horizon. Note that given the model we have chosen for the incident deaths outcome, we do need to make sure to generate the incident case forecast *first* so that we can retrieve point estimates for future cases, which will be passed into the incident deaths forecast:

```{r}
## generate incident case forecast
icases_forecast <- ts_forecast(fit.icases, outcome = "icases", horizon = 4)
icases_forecast

## need to get future cases to pass to ideaths forecast
future_cases <- ts_futurecases(usa, icases_forecast, horizon = 4)
# Forecast incident deaths based on best guess for cases
ideaths_forecast <- ts_forecast(fit.ideaths,  outcome = "ideaths", new_data = future_cases)
ideaths_forecast
```

We can use the forecasts of incidence to infer cumulative targets. The `ts_forecast()` function is flexible enough to switch methods internally, requiring a "inc_forecast" parameter if either "cdeaths" or "ccases" is passed as the "outcome" for the forecast:

```{r}
## generate cumulative forecasts
cdeaths_forecast <- ts_forecast(outcome = "cdeaths", .data = usa, inc_forecast = ideaths_forecast)
cdeaths_forecast
```

Prior to submitting these forecasts to the COVID-19 Forecast Hub we need to prepare them in the canonical submission format. Data prep in `format_for_submission` includes naming targets appropriately and ensuring that target dates adhere to epidemiological week format:

```{r}
## create submission object
submission <-
  list(format_for_submission(icases_forecast, target_name = "inc case"),
       format_for_submission(ideaths_forecast, target_name = "inc death"),
       format_for_submission(cdeaths_forecast, target_name = "cum death")) %>%
  reduce(bind_rows) %>%
  arrange(target)

submission
```

Last of all, we can validate the submission. The object must be written to a file and then validated with `validate_forecast()`, which wraps a python function developed and maintained by the COVID-19 Forecast Hub organizers. For more information on validating the entry see the "Submission validation" section below:

```{r, eval=FALSE}
## set up file path for submission file
## forcing the date in the file name and submission conents to be this monday
ffile <- file.path(tempdir(), paste0(this_monday(), "-sigsci-arima.csv"))
submission %>%
  mutate(forecast_date = this_monday()) %>%
  write_csv(ffile)

validate_forecast(ffile)
```

### Evaluating model accuracy

In order to facilitate model selection and evaluation, we included a wrapper function to generate model accuracy measures for multiple outcomes and models simultaneously. The `ts_accuracy()` function relies heavily on `ts_fit()`. As noted above, in basic usage it may not be necessary to use `ts_fit()` to generate forecasts / submissions. Furthermore, there are some models for which `ts_fit()` will not work. Those limitations will apply to `ts_accuracy()` as well.

However, `ts_fit()` can be useful for iterating over outcomes and arbitrary compatible models:

```{r}
ts_funs <- 
  list(
    ARIMA = function(x, .data) model(.data, ARIMA = ARIMA(x, stepwise=FALSE, approximation=FALSE)),
    SES_Additive = function(x, .data) model(.data, SES_additive = ETS(x ~ error("A") + trend("N") + season("N"))),
    SES_Multiplicative = function(x, .data) model(.data, SES_multiplicative = ETS(x ~ error("M") + trend("N") + season("N"))),
    Holt_Additive = function(x, .data) model(.data, Holt_Additive = ETS(x ~ error("A") + trend("A") + season("N"))),
    Holt_Multiplicative = function(x, .data) model(.data, Holt_Multiplicative = ETS(x ~ error("M") + trend("A") + season("N")))
  )

ts_fit(usa, outcomes = "icases", .fun = ts_funs, single = FALSE)
```

For convenience, the function can return a single `mable` (model tables) instead of a list if `single = TRUE` and there is only one outcome and model:


```{r}
ts_funs <- 
  list(
    ARIMA = function(x, .data) model(.data, ARIMA = ARIMA(x, stepwise=FALSE, approximation=FALSE))
  )

ts_fit(usa, outcomes = "icases", .fun = ts_funs, single = TRUE)
```

The `ts_accuracy()` function accepts a list of models and returns metrics for each model and outcome(s):

```{r}
ts_funs <- 
  list(
    ARIMA = function(x, .data) model(.data, ARIMA = ARIMA(x, stepwise=FALSE, approximation=FALSE)),
    SES_Additive = function(x, .data) model(.data, SES_additive = ETS(x ~ error("A") + trend("N") + season("N"))),
    SES_Multiplicative = function(x, .data) model(.data, SES_multiplicative = ETS(x ~ error("M") + trend("N") + season("N"))),
    Holt_Additive = function(x, .data) model(.data, Holt_Additive = ETS(x ~ error("A") + trend("A") + season("N"))),
    Holt_Multiplicative = function(x, .data) model(.data, Holt_Multiplicative = ETS(x ~ error("M") + trend("A") + season("N")))
  )

ts_accuracy(.data = usa, horizon = 4, outcomes = c("icases","ideaths"), .fun = ts_funs)
```

> **CAUTION**: The list passed to ".fun" in either `ts_accuracy()` or `ts_fit()` *must* include functions formatted exactly as the example above. These functions should all wrap `fable::model` with the outcome as "x" and data passed in as ".data".

## Submission validation

Submissions to the COVID-19 Forecast Hub must comply to the entry format for the forecast file:

https://github.com/reichlab/covid19-forecast-hub/blob/master/data-processed/README.md#forecast-file-format

The organizers have provided code to validate entry formats. We have included some of those methods in this repo, such that entry format can be checked as follows (uncomment the first line if you've installed dependencies to a conda environment called `focus`):

```
# conda activate focus
python3 inst/validation/validate_single_forecast_file.py scratch/fable-submission-mockup-allmetrics-forecasts/2021-01-04-sigsci-ts.csv
```

Note that the following Python modules should be installed:

```
pandas
requests
pymmwr
click
urllib3
selenium
webdriver-manager
pyyaml
PyGithub
git+https://github.com/reichlab/zoltpy/
https://github.com/hannanabdul55/pykwalify/archive/master.zip
```

You can install these dependencies by running the following. Optionally create and activate a conda environment prior to installing these dependencies.

```
# conda create -n focus
# conda activate focus
pip3 install -r inst/validation/requirements.txt
```

In order to run a very similar check using R, we have developed a wrapper to the [`validate_quantile_csv_file()` function from the `zoltpy` module](https://github.com/reichlab/zoltpy/blob/master/zoltpy/covid19.py#L75-L93), which drives the `validate_single_forecast_file.py` script above. To use the wrapper function in R:

```
validate_forecast("submission/SigSci-TS/2021-01-11-SigSci-TS.csv")
```

# Experimental: One-step pipeline

The **experimental** `forecast_pipeline()` function will run everything above, and return a list with models, forecasts, the formatted submission, and a suggested filename relative to the project directory to save the submission. See the examples in `?forecast_pipeline()`. For now this function only works on Mondays!

1. Get data (national level from JHU by default)
1. Fit incident case and incident death models (ARIMA and lagged TSLM respectively)
1. Get future case data to create the incident death forecast
1. Create the incident death forecast based on this new data
1. Prepare submission format
1. Suggest a submission filename
1. Return all resulting objects to a list.

```{r, eval=FALSE}
# Run the forecast pipeline. See ?forecast_pipeline
myforecast <- forecast_pipeline()

# Look at the submission and the suggested filename.
myforecast$submission
myforecast$submission_filename

# Write submission to file
readr::write_csv(myforecast$submission, file=myforecast$submission_filename)

# Validate submission
validate_forecast(myforecast$submission_filename)
```

